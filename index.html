<!DOCTYPE html>
<html>

<head>
	<link rel="stylesheet" href="style.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	<script src="helpers.js"></script>
	<script src="analytics.js"></script>
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-B9CC699D4M"></script>
	<!-- Google Tag Manager -->
	<script>
		(function (w, d, s, l, i) {
			w[l] = w[l] || [];
			w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
			var f = d.getElementsByTagName(s)[0],
				j = d.createElement(s),
				dl = l != "dataLayer" ? "&l=" + l : "";
			j.async = true;
			j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
			f.parentNode.insertBefore(j, f);
		})(window, document, "script", "dataLayer", "GTM-WNVB37S");
	</script>
	<!-- End Google Tag Manager -->
	<!-- Google tag (gtag.js) -->
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-B9CC699D4M"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'G-B9CC699D4M');
	</script>


</head>

<body>
	<div id="table_container">
		<table class="data_table" id="delivery_install_table">
			<thead>
				<tr>
					<th>Service</td>
					<th class="header">Best Buy Price</td>
					<th class="header">Home Depot Price</td>
					<th class="header">Lowes Price</td>
					<th class="header">Your Price</td>
					<th class="header">+/- Difference</td>
				</tr>
			</thead>
		</table>
	</div>
	<div id="sum_container">
		<p id="sum_display"></p>

		<p id="sum_explanation">
			Potential Opportunity for 4-piece delivery, install and haul-away.
			A positive value indicates potential opportunity gain (e.g you are
			charging less than competitors). Negative value indicates you are
			charging more than competitors.
		</p>
	</div>
	<div id="next_prev_btns">
		<a href="./four_piece_kitchen.html" class="next round" id="next_btn">&#8250;</a>
	</div>
	<script>

		const services = [
			"delivery_charges",
			"haul_away",
			"otr_install",
			"dw_install",
			"gas_dryer_install_no_steam",
			"gas_dryer_install_with_steam",
			"gas_range_install",
			"rubber_fill_hose",
			"ss_fill_hose_set",
			"vent_kit",
			"dryer_cord",
			"range_cord",
			"dw_kit",
			"h2o_hook_up",
			"four_piece_delivery",
		];



		window.onload = async (event) => {

			await $.getJSON(
				"https://nodetest-f6jnhptmxa-uc.a.run.app/delivery_install",
				function (result) {
					if (localStorage.getItem("delivery_install_display_data") != null) {
						localStorage.removeItem("delivery_install_display_data");
					}

					let table_display_data = result;
					localStorage.setItem(
						"delivery_install_display_data",
						JSON.stringify(table_display_data)
					);

					const price_data = result;
					price_data.forEach(function (element, index) {
						element.service = services[index];
					});

					if (localStorage.getItem("price_data") != null) {
						localStorage.removeItem("price_data");
					}

					localStorage.setItem("price_data", JSON.stringify(price_data));
				}
			);

			const table_display_data = JSON.parse(
				localStorage.getItem("delivery_install_display_data")
			);

			let data_arr = [];

			$.each(table_display_data, function (index, item) {
				data_arr.push("<tr>");
				$.each(item, function (index, item_data) {
					data_arr.push("<td id='item_data'>" + item_data + "</td>");
				});

				data_arr.push("<td class='member_input_td'>");
				data_arr.push("<input/>");
				data_arr.push(
					"<td class='difference_td' id=" +
					'"' +
					services[index] +
					"_difference" +
					'"' +
					"/>"
				);
				data_arr.push("</tr>");
			});

			const delivery_install_table = $("#delivery_install_table");

			delivery_install_table.append(data_arr.join(""));

			$("input").addClass("member_input");

			$("input").each(function (index, element) {
				$(element).attr("id", services[index]);
			});

			inputs = document.querySelectorAll(".member_input");
			inputs.forEach((element) => {
				element.addEventListener("input", function () {
					let input_id = this.id;
					let member_value = parseInt(this.value);
					//$(".member_input_td").text(member_value);
					let average = calculateAverage(input_id);
					let difference_td_id = document.getElementById(
						input_id + "_difference"
					).id;
					populateDifference(input_id, difference_td_id, average);
					//calculateSum();
				});
			});

			const four_piece_input = document.getElementById("four_piece_delivery");
			four_piece_input.readOnly = true;
			const delivery_input = document.getElementById("delivery_charges");
			const haul_away_input = document.getElementById("haul_away");
			const otr_install_input = document.getElementById("otr_install");
			const dw_install_input = document.getElementById("dw_install");
			const range_cord_input = document.getElementById("range_cord");
			const h2o_hook_up_input = document.getElementById("h2o_hook_up");
			h2o_hook_up_input.addEventListener("input", function () {
				if (
					delivery_input.value.length >= 1 &&
					haul_away_input.value.length >= 1 &&
					otr_install_input.value.length >= 1 &&
					dw_install_input.value.length >= 1 &&
					range_cord_input.value.length >= 1 &&
					h2o_hook_up_input.value.length >= 1
				) {
					let four_piece_member_price =
						parseInt(delivery_input.value) +
						parseInt(haul_away_input.value) * 4 +
						parseInt(otr_install_input.value) +
						parseInt(dw_install_input.value) +
						parseInt(range_cord_input.value) +
						parseInt(h2o_hook_up_input.value);

					four_piece_input.placeholder = four_piece_member_price;

					let table = document.getElementById("delivery_install_table");
					let lastRow = table.rows[table.rows.length - 1];
					let best_buy_price = cleanPrice(lastRow.cells[1].innerText);
					let home_depot_price = cleanPrice(lastRow.cells[2].innerText);
					let lowes_price = cleanPrice(lastRow.cells[3].innerText);

					let four_piece_difference = document.getElementById(
						"four_piece_delivery_difference"
					);

					let difference = Math.round(
						(best_buy_price + home_depot_price + lowes_price) / 3 -
						four_piece_member_price
					);
					four_piece_difference.innerText = "$" + difference;
					let sum_display = document.getElementById("sum_display");
					sum_display.innerText = "$" + difference;
				}
			});

			document.getElementById("next_btn").onclick = async () => {
				await storeMemberInputs();
				await storeTableDeliveryInstall();
			};
		};
	</script>
</body>

</html>