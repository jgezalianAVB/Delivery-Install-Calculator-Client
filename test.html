<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
      $.getJSON("http://127.0.0.1:5500/data.json", function (result) {
        table_display_data = result;
        localStorage.setItem(
          "table_display_data",
          JSON.stringify(table_display_data)
        );

        const price_data = result;
        price_data.forEach(function (element, index) {
          element.service = services[index];
        });

        localStorage.setItem("price_data", JSON.stringify(price_data));
      });
      const services = [
        "delivery_charges",
        "haul_away",
        "otr_install",
        "dw_install",
        "gas_dryer_install_no_steam",
        "gas_dryer_install_with_steam",
        "gas_range_install",
        "rubber_fill_hose",
        "ss_fill_hose_set",
        "vent_kit",
        "dryer_cord",
        "range_cord",
        "dw_kit",
        "h2o_hook_up",
        "four_piece_delivery",
      ];
      window.onload = (event) => {
        const table_display_data = JSON.parse(
          localStorage.getItem("table_display_data")
        );

        const test_table = $("#test_table");
        let data_arr = [];

        $.each(table_display_data, function (index, item) {
          data_arr.push("<tr>");
          $.each(item, function (index, item_data) {
            data_arr.push("<td id='item_data'>" + item_data + "</td>");
          });

          data_arr.push("<td class='member_input_td'>");
          data_arr.push("<input/>");
          data_arr.push(
            "<td class='difference_td' id=" +
              '"' +
              services[index] +
              "_difference" +
              '"' +
              "/>"
          );
          data_arr.push("</tr>");
        });

        test_table.append(data_arr.join(""));

        $("input").addClass("member_input");

        $("input").each(function (index, element) {
          $(element).attr("id", services[index]);
        });

        //initializeDifferenceTd()

        inputs = document.querySelectorAll(".member_input");
        inputs.forEach((element) => {
          element.addEventListener("input", function () {
            let input_id = this.id;
            let member_value = parseInt(this.value);
            let average = calculateAverage(input_id);
            let difference_td_id = document.getElementById(
              input_id + "_difference"
            ).id;
            populateDifference(input_id, difference_td_id, average);
            calculateSum();
          });
        });
      };
    </script>
    <script>
      function cleanPrice(price) {
        const match_dollar = /\$?[0-9]+(\.[0-9][0-9])?/g;
        $.trim(price);
        let price_arr = price.match(match_dollar);
        if (price_arr) {
          price = price_arr[0].replace("$", "");
          return parseInt(price);
        }
        return 0;
      }

      function calculateAverage(service) {
        data = JSON.parse(localStorage.getItem("price_data"));
        for (let i = 0; i < data.length; i++) {
          if (data[i].service == service) {
            let count = 0;

            const best_buy_price = cleanPrice(data[i].best_buy_price);
            if (best_buy_price != 0) {
              count++;
            }
            const home_depot_price = cleanPrice(data[i].home_depot_price);
            if (home_depot_price != 0) {
              count++;
            }
            const lowes_price = cleanPrice(data[i].lowes_price);
            if (lowes_price != 0) {
              count++;
            }

            const average =
              (best_buy_price + home_depot_price + lowes_price) / count;
            return Math.round(average);
          }
        }
      }

      function populateDifference(member_price_id, difference_id, average) {
        let member_input = document.getElementById(member_price_id);
        let difference_el = document.getElementById(difference_id);

        if (member_input.value == 0) {
          difference_el.innerText = average;
        }
        if (member_input.value > 0) {
          difference = average - member_input.value;
          difference_el.innerText = difference;
        }
        if (!member_input.value) {
          difference_el.innerText = "";
        }
      }

      function calculateSum() {
        const summed_data = document.getElementById("sum_display");
        let value = 0;
        let difference_tds = document.querySelectorAll(".difference_td");
        for (let i = 0; i < difference_tds.length; i++) {
          if (difference_tds[i].innerText) {
            value += parseInt(difference_tds[i].innerText);
          }
        }
        summed_data.innerText = value;
      }
    </script>
  </head>
  <body>
    <table class="data_table" id="test_table">
      <thead>
        <tr>
          <td></td>
          <td class="header">Best Buy</td>
          <td class="header">Home Depot</td>
          <td class="header">Lowes</td>
          <td class="header">Your Price</td>
          <td class="header">+/- Difference</td>
        </tr>
      </thead>
    </table>
    <div id="sum_container">
      <p id="sum_display"></p>

      <p id="sum_explanation">
        Summed total of &#40; competitor average - your price &#41;. A positive
        value indicates potential opportunity gain (e.g you are charging less
        than competitors). Negative value indicates you are charging more than
        competitors.
      </p>
    </div>
  </body>
</html>
